{"version":3,"sources":["..\\..\\..\\..\\..\\..\\assets\\Texture\\joystick\\script/assets\\Texture\\joystick\\script\\Joystick.js"],"names":["cc","Class","extends","Component","properties","dot","default","type","Node","displayName","tooltip","ring","player","joystickType","JoystickCommon","JoystickType","FIXED","directionType","DirectionType","ALL","_stickPos","_touchLocation","onLoad","_radius","width","_initTouchEvent","FOLLOW","node","opacity","self","on","EventType","TOUCH_START","_touchStartEvent","TOUCH_MOVE","_touchMoveEvent","TOUCH_END","_touchEndEvent","TOUCH_CANCEL","event","touchPos","convertToNodeSpaceAR","getLocation","getPosition","distance","sub","mag","setPosition","posX","x","posY","y","p","v2","normalize","_speedType","SpeedType","NORMAL","FAST","getComponent","moveDir","STOP","setPlayerSpeed","speedType"],"mappings":"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","file":"Joystick.js","sourceRoot":"..\\..\\..\\..\\..\\..\\assets\\Texture\\joystick\\script","sourcesContent":["import JoystickCommon from 'JoystickCommon'\n\ncc.Class({\n  extends: cc.Component,\n\n  properties: {\n    dot: {\n      default: null,\n      type: cc.Node,\n      displayName: 'Dot',\n      tooltip: '摇杆操纵点',\n    },\n    ring: {\n      default: null,\n      type: cc.Node,\n      displayName: 'Ring',\n      tooltip: '摇杆背景节点',\n    },\n\n    player: {\n      default: null,\n      type: cc.Node,\n      displayName: 'Player',\n      tooltip: '操控角色',\n    },\n\n    joystickType: {\n      default: JoystickCommon.JoystickType.FIXED,\n      type: JoystickCommon.JoystickType,\n      displayName: 'Touch Type',\n      tooltip: '触摸类型',\n    },\n    directionType: {\n      default: JoystickCommon.DirectionType.ALL,\n      type: JoystickCommon.DirectionType,\n      displayName: 'Direction Type',\n      tooltip: '方向类型',\n    },\n\n    _stickPos: {\n      default: null,\n      type: cc.Node,\n      tooltip: '摇杆所在位置',\n    },\n    _touchLocation: {\n      default: null,\n      type: cc.Node,\n      tooltip: '触摸位置',\n    },\n  },\n\n  onLoad() {\n    this._radius = this.ring.width / 2;\n    this._initTouchEvent();\n    // hide joystick when follow\n    if (this.joystickType == JoystickCommon.JoystickType.FOLLOW) {\n      this.node.opacity = 0;\n    }\n  },\n\n  _initTouchEvent() {\n    // set the size of joystick node to control scale\n    const self = this;\n    self.node.on(cc.Node.EventType.TOUCH_START, self._touchStartEvent, self);\n    self.node.on(cc.Node.EventType.TOUCH_MOVE, self._touchMoveEvent, self);\n    self.node.on(cc.Node.EventType.TOUCH_END, self._touchEndEvent, self);\n    self.node.on(cc.Node.EventType.TOUCH_CANCEL, self._touchEndEvent, self);\n  },\n\n  _touchStartEvent(event) {\n    const touchPos = this.node.convertToNodeSpaceAR(event.getLocation());\n\n    if (this.joystickType === JoystickCommon.JoystickType.FIXED) {\n      this._stickPos = this.ring.getPosition();\n\n      // 触摸点与圆圈中心的距离\n      const distance = touchPos.sub(this.ring.getPosition()).mag();\n\n      // 手指在圆圈内触摸,控杆跟随触摸点\n      if (this._radius > distance) {\n        this.dot.setPosition(touchPos);\n      }\n\n    } else if (this.joystickType === JoystickCommon.JoystickType.FOLLOW) {\n\n      // 记录摇杆位置，给 touch move 使用\n      this._stickPos = touchPos;\n      this.node.opacity = 255;\n      this._touchLocation = event.getLocation();\n      \n      // 更改摇杆的位置\n      this.ring.setPosition(touchPos);\n      this.dot.setPosition(touchPos);\n    }\n  },\n\n  _touchMoveEvent(event) {\n    if (this.joystickType === JoystickCommon.JoystickType.FOLLOW) {\n      // 如果 touch start 位置和 touch move 相同，禁止移动\n      if (this._touchLocation === event.getLocation()) {\n        return false;\n      }\n    }\n\n    // 以圆圈为锚点获取触摸坐标\n    const touchPos = this.ring.convertToNodeSpaceAR(event.getLocation());\n    const distance = touchPos.mag();\n\n    // 由于摇杆的 postion 是以父节点为锚点，所以定位要加上 touch start 时的位置\n    const posX = this._stickPos.x + touchPos.x;\n    const posY = this._stickPos.y + touchPos.y;\n\n    // 归一化\n    const p = cc.v2(posX, posY).sub(this.ring.getPosition()).normalize();\n\n    if (this._radius > distance) {\n      this.dot.setPosition(cc.v2(posX, posY));\n\n      this.player._speedType = JoystickCommon.SpeedType.NORMAL;\n    } else {\n      // 控杆永远保持在圈内，并在圈内跟随触摸更新角度\n      const x = this._stickPos.x + p.x * this._radius;\n      const y = this._stickPos.y + p.y * this._radius;\n      this.dot.setPosition(cc.v2(x, y));\n\n      this.player._speedType = JoystickCommon.SpeedType.FAST;\n    }\n\n    this.player = this.player.getComponent('Player');\n    this.player.moveDir = p;\n  },\n\n  _touchEndEvent() {\n    this.dot.setPosition(this.ring.getPosition());\n    if (this.joystickType == JoystickCommon.JoystickType.FOLLOW) {\n      this.node.opacity = 0;\n    }\n    this.player._speedType = JoystickCommon.SpeedType.STOP;\n  },\n\n  // methods\n\n  setPlayerSpeed() {\n    this.player = this.player.getComponent('Player');\n    this.player.moveDir = p;\n    this.player.speedType = JoystickCommon.SpeedType.NORMAL;\n  },\n});\n"]}